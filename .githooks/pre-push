#!/usr/bin/env bash
set -euo pipefail

found=0
while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "$local_sha" == "0000000000000000000000000000000000000000" ]]; then
    continue
  fi
  if [[ "$remote_sha" == "0000000000000000000000000000000000000000" ]]; then
    range="$local_sha"
  else
    range="$remote_sha..$local_sha"
  fi
  if git log -p "$range" | grep -E 'sk-or-[A-Za-z0-9_-]{10,}' >/dev/null; then
    found=1
  fi
done

if [[ "$found" -ne 0 ]]; then
  echo "Error: OpenRouter API key detected in commits being pushed." >&2
  echo "Remove the key or rewrite history before pushing." >&2
  exit 1
fi
